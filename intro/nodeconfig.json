[
    {
        "_id": "customers",
        "type": "pipe",
        "source": {
            "type": "json_remote",
            "url": "customers.json"
        },
        "pump": {
            "run_at_startup": true
        }
    },
    {
        "_id": "orders",
        "type": "pipe",
        "source": {
            "type": "json_remote",
            "url": "orders.json"
        },
        "pump": {
            "run_at_startup": true
        }
    },
    {
        "_id": "customers-with-orders",
        "type": "pipe",
        "source": {
            "type": "dataset",
            "dataset": "customers"
        },
        "transform": {
            "type": "dtl",
            "dataset": "customers",
            "transforms": {
                "default": [
                    ["add", "type", "customer"],
                    ["add", "name", ["concat", ["list", "_S.first_name", " ", "_S.last_name"]]],
                    ["add", "orders", ["apply", "order", ["hops", {
                        "datasets": ["orders o"],
                        "where": [
                            ["eq", "_S._id", "o.customer_id"]
                        ]
                    }]]],
                    ["add", "order_count", ["count", "_T.orders"]]
                ],
                "order": [
                    ["copy", ["items", "discount"]],
                    ["add", "total",
                     ["minus",
                      ["coalesce", ["list", "_S.discount", 0]],
                      ["sum", ["map", ["multiply", "_.quantity", "_.price"], "_S.items"]]]]
                ]
            }
        }
    }
]
