[
  {
    "_id": "crm-customer",
    "type": "pipe",
    "source": {
      "type": "http_endpoint"
    }
  },
  {
    "_id": "erp-customer",
    "type": "pipe",
    "source": {
      "type": "http_endpoint"
    }
  },
  {
    "_id": "erp-order",
    "type": "pipe",
    "source": {
      "type": "http_endpoint"
    }
  },
  {
    "_id": "global-order",
    "type": "pipe",
    "source": {
      "type": "dataset",
      "dataset": "erp-order"
    }
  },
  {
    "_id": "merged-customer",
    "type": "pipe",
    "source": {
      "type": "merge",
      "datasets": ["erp-customer erp", "crm-customer crm"],
      "equality": [
        ["eq", "erp.erp-customer:company_id", "crm.crm-customer:company_id"]
      ]
    }
  },
  {
    "_id": "global-customer",
    "type": "pipe",
    "source": {
      "type": "dataset",
      "dataset": "merged-customer"
    },
    "transform": {
      "type": "dtl",
      "rules": {
        "default": [
          ["copy", "*"],
          ["add", "type", "customer"],
          ["add", "name",
            ["concat",
              ["list", "_S.first_name", " ", "_S.last_name"]
            ]
          ],
          ["add", "_orders",
            ["apply", "order",
              ["hops", {
                "datasets": ["global-order o"],
                "where": [
                  ["eq", "_S.$ids", "o.customer_id"]
                ]
              }]
            ]
          ],
          ["add", "order_count",
            ["count", "_T._orders"]
          ],
          ["add", "total",
            ["sum",
              ["map", "_.total", "_T._orders"]
            ]
          ]
        ],
        "order": [
          ["add", "total",
            ["minus",
              ["coalesce",
                ["list", "_S.discount", 0]
              ],
              ["sum",
                ["map",
                  ["multiply", "_.quantity", "_.price"], "_S.items"]
              ]
            ]
          ]
        ]
      }
    },
    "namespaced_identifiers": true
  },
  {
    "_id": "crm-vip-customer",
    "type": "pipe",
    "source": {
      "type": "dataset",
      "dataset": "global-customer"
    },
    "transform": {
      "type": "dtl",
      "rules": {
        "default": [
          ["add", "_id", "_S.crm-customer:id"],
          ["filter",
            ["gt", "_S.global-customer:total", 25]
          ],
          ["add", "is-vip", true]
        ]
      }
    }
  }
]
