[
  {
    "_id": "customers",
    "type": "pipe",
    "source": {
      "type": "http_endpoint"
    }
  },
  {
    "_id": "order-customers",
    "type": "pipe",
    "source": {
      "type": "http_endpoint"
    }
  },
  {
    "_id": "orders",
    "type": "pipe",
    "source": {
      "type": "http_endpoint"
    }
  },  
  {
    "_id": "merged-customers",
    "type": "pipe",
    "source": {
      "type": "merge",
      "datasets": ["customers c", "order-customers oc"],
      "equality": [
        ["eq", "c.customers:company_id", "oc.order-customers:company_id"]
      ]
    }
  },
  {
    "_id": "global-customers",
    "type": "pipe",
    "source": {
      "type": "dataset",
      "dataset": "merged-customers"
    },
    "transform": {
      "type": "dtl",
      "rules": {
        "default": [
          ["copy", "*"],
          ["add", "type", "customer"],
          ["add", "name",
            ["concat",
              ["list", "_S.first_name", " ", "_S.last_name"]
            ]
          ],
          ["add", "_orders",
            ["apply", "order",
              ["hops", {
                "datasets": ["orders o"],
                "where": [
                  ["eq", "_S.$ids", "o.customer_id"]
                ]
              }]
            ]
          ],
          ["add", "order_count",
            ["count", "_T._orders"]
          ],
          ["add", "total",
            ["sum",
              ["map", "_.total", "_T._orders"]
            ]
          ]
        ],
        "order": [
          ["add", "total",
            ["minus",
              ["coalesce",
                ["list", "_S.discount", 0]
              ],
              ["sum",
                ["map",
                  ["multiply", "_.quantity", "_.price"], "_S.items"]
              ]
            ]
          ]
        ]
      }
    },
    "namespaced_identifiers": true
  },
  {
    "_id": "vip-customers",
    "type": "pipe",
    "source": {
      "type": "dataset",
      "dataset": "global-customers"
    },
    "transform": {
      "type": "dtl",
      "rules": {
        "default": [
          ["add", "_id", "_S.customers:id"],
          ["filter",
            ["gt", "_S.global-customers:total", 25]
          ]
        ]
      }
    }
  }
]
