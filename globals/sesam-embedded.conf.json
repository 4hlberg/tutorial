[
  {
    "_id": "crm-customer",
    "type": "pipe",
    "source": {
      "type": "embedded",
      "entities": [
    {"_id": "crm-customer:1",
     "crm-customer:id": "1",
     "crm-customer:company_id": "JSM",
     "crm-customer:first_name": "John",
     "crm-customer:last_name": "Smith",
     "crm-customer:age": 42},
    {"_id": "crm-customer:2",
     "crm-customer:id": "2",
     "crm-customer:company_id": "MHA",
     "crm-customer:first_name": "Maria",
     "crm-customer:last_name": "Hawkins",
     "crm-customer:age": 32},
    {"_id": "crm-customer:3",
     "crm-customer:id": "3",
     "crm-customer:company_id": "PCU",
     "crm-customer:first_name": "Pam",
     "crm-customer:last_name": "Curie",
     "crm-customer:age": 21}
]
    }
  },
  {
    "_id": "erp-customer",
    "type": "pipe",
    "source": {
      "type": "embedded",
      "entities": [
    {"_id": "erp-customer:11",
     "erp-customer:company_id": "JSM"},
    {"_id": "erp-customer:12",
     "erp-customer:company_id": "MHA"}
]
    }
  },
  {
    "_id": "erp-order",
    "type": "pipe",
    "source": {
      "type": "embedded",
      "entities": [
    {"_id": "erp-order:1000",
     "erp-order:customer_id": "~:erp-customer:10",
     "erp-order:items": [
         {"ean": "978-1852493110", "price": 22.10, "quantity": 2 }
     ],
     "erp-order:discount": 4.20},
    {"_id": "erp-order:1001",
     "erp-order:customer_id": "~:erp-customer:11",
     "erp-order:items": [
         {"ean": "978-0937381939", "price": 73.50, "quantity": 1 },
         {"ean": "978-0060005719", "price": 10.40, "quantity": 1 }
     ]},
    {"_id": "erp-order:1002",
     "erp-order:customer_id": "~:erp-customer:12",
     "erp-order:items": [
         {"ean": "978-0195367133", "price": 39.95, "quantity": 1 }
     ]}
]
    }
  },
  {
    "_id": "global-order",
    "type": "pipe",
    "source": {
      "type": "dataset",
      "dataset": "erp-order"
    }
  },
  {
    "_id": "merged-customer",
    "type": "pipe",
    "source": {
      "type": "merge",
      "datasets": ["erp-customer erp", "crm-customer crm"],
      "equality": [
        ["eq", "erp.erp-customer:company_id", "crm.crm-customer:company_id"]
      ]
    }
  },
  {
    "_id": "global-customer",
    "type": "pipe",
    "source": {
      "type": "dataset",
      "dataset": "merged-customer"
    },
    "transform": {
      "type": "dtl",
      "rules": {
        "default": [
          ["copy", "*"],
          ["add", "type", "customer"],
          ["add", "name",
            ["concat",
              ["list", "_S.first_name", " ", "_S.last_name"]
            ]
          ],
          ["add", "_orders",
            ["apply", "order",
              ["hops", {
                "datasets": ["global-order o"],
                "where": [
                  ["eq", "_S.$ids", "o.customer_id"]
                ]
              }]
            ]
          ],
          ["add", "order_count",
            ["count", "_T._orders"]
          ],
          ["add", "total",
            ["sum",
              ["map", "_.total", "_T._orders"]
            ]
          ]
        ],
        "order": [
          ["add", "total",
            ["minus",
              ["coalesce",
                ["list", "_S.discount", 0]
              ],
              ["sum",
                ["map",
                  ["multiply", "_.quantity", "_.price"], "_S.items"]
              ]
            ]
          ]
        ]
      }
    },
    "namespaced_identifiers": true
  },
  {
    "_id": "crm-vip-customer",
    "type": "pipe",
    "source": {
      "type": "dataset",
      "dataset": "global-customer"
    },
    "transform": {
      "type": "dtl",
      "rules": {
        "default": [
          ["add", "_id", "_S.crm-customer:id"],
          ["filter",
            ["gt", "_S.global-customer:total", 25]
          ],
          ["add", "is-vip", true]
        ]
      }
    }
  }
]
